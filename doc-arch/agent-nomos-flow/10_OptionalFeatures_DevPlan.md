# N0mosAi - å¯é€‰åŠŸèƒ½å¼€å‘è®¡åˆ’ (Phase 3)

> **æ–‡æ¡£ç‰ˆæœ¬**: 1.0
> **æœ€åæ›´æ–°**: 2026-02-25
> **çŠ¶æ€**: Draft
> **å‰ç½®ä¾èµ–**: Phase 2 (Advanced Features) å®Œæˆ
> **å…³è”æ–‡æ¡£**: [06_Development_Plan_Overview.md](06_Development_Plan_Overview.md)

æœ¬æ–‡æ¡£å®šä¹‰ Phase 3 (Optional Features) çš„è¯¦ç»†å¼€å‘è®¡åˆ’ï¼Œç›®æ ‡æ˜¯æ‰©å±•èƒ½åŠ›å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

---

## ç›®å½•

1. [é˜¶æ®µç›®æ ‡](#1-é˜¶æ®µç›®æ ‡)
2. [Gate 3.1: å¤šè¯­è¨€æ”¯æŒ](#2-gate-31-å¤šè¯­è¨€æ”¯æŒ)
3. [Gate 3.2: æ€§èƒ½ä¼˜åŒ–](#3-gate-32-æ€§èƒ½ä¼˜åŒ–)
4. [Gate 3.3: é…ç½®å¢å¼º](#4-gate-33-é…ç½®å¢å¼º)
5. [Gate 3.4: æ–‡æ¡£ä¸æµ‹è¯•](#5-gate-34-æ–‡æ¡£ä¸æµ‹è¯•)
6. [Gate é—´ä¾èµ–å…³ç³»](#6-gate-é—´ä¾èµ–å…³ç³»)
7. [éªŒæ”¶æ ‡å‡†](#7-éªŒæ”¶æ ‡å‡†)
8. [æŠ€æœ¯å†³ç­–è®°å½•](#8-æŠ€æœ¯å†³ç­–è®°å½•)

---

## 1. é˜¶æ®µç›®æ ‡

### 1.1 ç›®æ ‡å£°æ˜

**Phase 3 ç›®æ ‡**: åœ¨æ ¸å¿ƒåŠŸèƒ½å’Œé«˜çº§åŠŸèƒ½ç¨³å®šçš„åŸºç¡€ä¸Šï¼Œæ‰©å±•å¤šè¯­è¨€ AST è§£æèƒ½åŠ›ã€ä¼˜åŒ–å¤§å‹é¡¹ç›®æ€§èƒ½ã€å®Œå–„é…ç½®ç³»ç»Ÿå’Œæ–‡æ¡£æµ‹è¯•ä½“ç³»ã€‚

### 1.2 æˆåŠŸæ ‡å‡†

- [ ] Tree-sitter é›†æˆæ”¯æŒ Python/JS/TS/Java/Go äº”ç§è¯­è¨€çš„ AST è§£æ
- [ ] å¢é‡ Linter æ£€æŸ¥ä½¿å¤§å‹é¡¹ç›®æ£€æŸ¥å»¶è¿Ÿ < 10 ç§’
- [ ] YAML é…ç½®ç¬¬ä¸‰å±‚è§„åˆ™å®ç°é›¶ä»£ç è‡ªå®šä¹‰
- [ ] Linter è¯¯æŠ¥äººå·¥è¦†ç›–æœºåˆ¶å®Œå–„ (ä¸‰çº§è±å…)
- [ ] å®Œæ•´ç”¨æˆ·æ–‡æ¡£å’Œ API æ–‡æ¡£
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%ï¼Œé›†æˆæµ‹è¯•è¦†ç›–æ ¸å¿ƒæµç¨‹

### 1.3 èŒƒå›´è¾¹ç•Œ

- **åŒ…å«**: Tree-sitter å¤šè¯­è¨€ã€å¢é‡æ£€æŸ¥ã€ç¼“å­˜/å¹¶è¡Œã€YAML é…ç½®ã€è±å…æœºåˆ¶ã€è·¨æ–‡ä»¶æ£€æŸ¥ã€å®Œæ•´æ–‡æ¡£ã€æµ‹è¯•ä½“ç³»
- **ä¸åŒ…å«**: åˆ†å¸ƒå¼ Linterã€IDE æ’ä»¶ã€äº‘ç«¯æœåŠ¡

---

## 2. Gate 3.1: å¤šè¯­è¨€æ”¯æŒ

> **å…³è”éœ€æ±‚**: FR-101
> **é¢„è®¡å·¥æœŸ**: 5 å¤©
> **å‰ç½®ä¾èµ–**: Phase 2 å…¨éƒ¨ Gate å®Œæˆ

### 2.1 ç›®æ ‡

ä¸º Nomos Workflow çš„ Linter å±‚å¼•å…¥ Tree-sitter å¤šè¯­è¨€ AST è§£æèƒ½åŠ›ï¼Œæ”¯æŒ Python / JavaScript / TypeScript / Go / Java äº”ç§è¯­è¨€çš„è¯­æ³•æ ‘åˆ†æï¼Œå®ç°è¯­è¨€è‡ªåŠ¨æ£€æµ‹å’Œåˆ†è¯­è¨€è§„åˆ™é›†åŠ è½½ã€‚

### 2.2 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Gate 3.1: å¤šè¯­è¨€æ”¯æŒæ¶æ„                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚  æ–‡ä»¶è¾“å…¥    â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     æ‰©å±•åæ˜ å°„      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ è¯­è¨€è‡ªåŠ¨æ£€æµ‹ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ .claude/rules/        â”‚ â”‚
â”‚  â”‚ (æ‰©å±•ååŒ¹é…) â”‚                     â”‚   languages.yml       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Tree-sitter è§£æå¼•æ“                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  Python  â”‚ â”‚  JS/TS   â”‚ â”‚   Go     â”‚ â”‚  Java    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Parser  â”‚ â”‚  Parser  â”‚ â”‚  Parser  â”‚ â”‚  Parser  â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚       â”‚             â”‚            â”‚             â”‚          â”‚   â”‚
â”‚  â”‚       â–¼             â–¼            â–¼             â–¼          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚           ç»Ÿä¸€ AST æŠ½è±¡å±‚ (UnifiedAST)           â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - å‡½æ•°ç­¾åæå–                                   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - å¯¼å…¥åˆ†æ                                       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - è°ƒç”¨é“¾è¿½è¸ª                                     â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              åˆ†è¯­è¨€è§„åˆ™é›†                                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚   â”‚
â”‚  â”‚  â”‚ Python:        â”‚  â”‚ JS/TS:         â”‚                  â”‚   â”‚
â”‚  â”‚  â”‚  ruff + bandit â”‚  â”‚  eslint +      â”‚                  â”‚   â”‚
â”‚  â”‚  â”‚                â”‚  â”‚  semgrep       â”‚                  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚   â”‚
â”‚  â”‚  â”‚ Go:            â”‚  â”‚ Java:          â”‚                  â”‚   â”‚
â”‚  â”‚  â”‚  golangci-lint â”‚  â”‚  checkstyle +  â”‚                  â”‚   â”‚
â”‚  â”‚  â”‚  + gosec       â”‚  â”‚  spotbugs      â”‚                  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚  ç»Ÿä¸€ç»“æœè¾“å‡º â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ ¸å¿ƒæ¥å£

```python
# === è¯­è¨€æ£€æµ‹å™¨ ===
from pathlib import Path
from dataclasses import dataclass, field
from typing import Optional
from enum import Enum

class Language(Enum):
    PYTHON = "python"
    JAVASCRIPT = "javascript"
    TYPESCRIPT = "typescript"
    GO = "go"
    JAVA = "java"
    UNKNOWN = "unknown"

# æ‰©å±•å â†’ è¯­è¨€æ˜ å°„ (é»˜è®¤å€¼ï¼Œå¯è¢« languages.yml è¦†ç›–)
DEFAULT_EXTENSION_MAP: dict[str, Language] = {
    ".py": Language.PYTHON,
    ".js": Language.JAVASCRIPT,
    ".ts": Language.TYPESCRIPT,
    ".tsx": Language.TYPESCRIPT,
    ".jsx": Language.JAVASCRIPT,
    ".go": Language.GO,
    ".java": Language.JAVA,
}

class LanguageDetector:
    """åŸºäºæ–‡ä»¶æ‰©å±•åçš„è¯­è¨€è‡ªåŠ¨æ£€æµ‹å™¨"""

    def __init__(self, config_path: Optional[Path] = None):
        self._ext_map = dict(DEFAULT_EXTENSION_MAP)
        if config_path and config_path.exists():
            self._load_config(config_path)

    def detect(self, file_path: Path) -> Language:
        return self._ext_map.get(file_path.suffix, Language.UNKNOWN)

    def _load_config(self, config_path: Path) -> None:
        """ä» .claude/rules/languages.yml åŠ è½½è‡ªå®šä¹‰æ˜ å°„"""
        ...


# === Tree-sitter AST è§£æå™¨ ===
@dataclass
class FunctionSignature:
    name: str
    params: list[str]
    return_type: Optional[str]
    line_number: int

@dataclass
class ImportInfo:
    module: str
    names: list[str]
    is_relative: bool
    line_number: int

@dataclass
class CallSite:
    caller: str
    callee: str
    line_number: int

@dataclass
class UnifiedAST:
    """ç»Ÿä¸€ AST æŠ½è±¡ â€” è·¨è¯­è¨€é€šç”¨ç»“æ„"""
    language: Language
    functions: list[FunctionSignature] = field(default_factory=list)
    imports: list[ImportInfo] = field(default_factory=list)
    call_sites: list[CallSite] = field(default_factory=list)

class TreeSitterEngine:
    """Tree-sitter å¤šè¯­è¨€è§£æå¼•æ“"""

    def __init__(self):
        self._parsers: dict[Language, object] = {}

    def parse(self, source: bytes, language: Language) -> UnifiedAST:
        """è§£ææºä»£ç ï¼Œè¿”å›ç»Ÿä¸€ AST"""
        ...

    def extract_functions(self, ast: UnifiedAST) -> list[FunctionSignature]:
        """æå–å‡½æ•°ç­¾å"""
        ...

    def extract_imports(self, ast: UnifiedAST) -> list[ImportInfo]:
        """æå–å¯¼å…¥ä¿¡æ¯"""
        ...

    def trace_calls(self, ast: UnifiedAST) -> list[CallSite]:
        """è¿½è¸ªè°ƒç”¨é“¾"""
        ...


# === åˆ†è¯­è¨€è§„åˆ™é›† ===
@dataclass
class LintResult:
    rule_id: str
    severity: str          # "error" | "warning" | "info"
    message: str
    file_path: str
    line_number: int
    language: Language

class LanguageRuleSet:
    """åˆ†è¯­è¨€è§„åˆ™é›†åŸºç±»"""

    def __init__(self, language: Language):
        self.language = language

    def run(self, file_path: Path) -> list[LintResult]:
        raise NotImplementedError

class PythonRuleSet(LanguageRuleSet):
    """Python: ruff + bandit"""
    def run(self, file_path: Path) -> list[LintResult]: ...

class JSTypeScriptRuleSet(LanguageRuleSet):
    """JS/TS: eslint + semgrep"""
    def run(self, file_path: Path) -> list[LintResult]: ...

class GoRuleSet(LanguageRuleSet):
    """Go: golangci-lint + gosec"""
    def run(self, file_path: Path) -> list[LintResult]: ...

class JavaRuleSet(LanguageRuleSet):
    """Java: checkstyle + spotbugs"""
    def run(self, file_path: Path) -> list[LintResult]: ...
```

### 2.4 è¯­è¨€é…ç½®æ–‡ä»¶ç¤ºä¾‹

```yaml
# .claude/rules/languages.yml
version: "1.0"

# æ‰©å±•å â†’ è¯­è¨€æ˜ å°„ (è¦†ç›–é»˜è®¤å€¼)
extensions:
  ".py": python
  ".pyi": python
  ".js": javascript
  ".jsx": javascript
  ".ts": typescript
  ".tsx": typescript
  ".go": go
  ".java": java

# åˆ†è¯­è¨€è§„åˆ™é›†é…ç½®
rulesets:
  python:
    linters:
      - name: ruff
        enabled: true
        config: ".ruff.toml"
      - name: bandit
        enabled: true
        severity: medium
  javascript:
    linters:
      - name: eslint
        enabled: true
        config: ".eslintrc.yml"
      - name: semgrep
        enabled: true
        rules: "p/javascript"
  typescript:
    linters:
      - name: eslint
        enabled: true
        config: ".eslintrc.yml"
      - name: semgrep
        enabled: true
        rules: "p/typescript"
  go:
    linters:
      - name: golangci-lint
        enabled: true
        config: ".golangci.yml"
      - name: gosec
        enabled: true
  java:
    linters:
      - name: checkstyle
        enabled: true
        config: "checkstyle.xml"
      - name: spotbugs
        enabled: true
```

### 2.5 å®æ–½æ­¥éª¤

| æ­¥éª¤ | ä»»åŠ¡ | äº§å‡º | é¢„è®¡è€—æ—¶ |
|:---:|------|------|:-------:|
| 1 | å®‰è£… tree-sitter åŠè¯­è¨€ç»‘å®š | `requirements.txt` æ›´æ–° | 0.5 å¤© |
| 2 | å®ç° `LanguageDetector` | `language_detector.py` | 0.5 å¤© |
| 3 | å®ç° `TreeSitterEngine` + `UnifiedAST` | `tree_sitter_engine.py` | 1.5 å¤© |
| 4 | å®ç°åˆ†è¯­è¨€è§„åˆ™é›† (Python/JS/TS/Go/Java) | `rulesets/*.py` | 1.5 å¤© |
| 5 | ç¼–å†™ `languages.yml` é…ç½®åŠ è½½é€»è¾‘ | `config/languages.py` | 0.5 å¤© |
| 6 | å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• | `tests/test_gate_3_1_*.py` | 0.5 å¤© |

### 2.6 Gate å®Œæˆæ¡ä»¶

- [ ] `LanguageDetector` æ­£ç¡®è¯†åˆ« 5 ç§è¯­è¨€ + UNKNOWN
- [ ] `TreeSitterEngine` å¯¹æ¯ç§è¯­è¨€å‡å¯è§£æå¹¶è¿”å› `UnifiedAST`
- [ ] å‡½æ•°ç­¾åæå–ã€å¯¼å…¥åˆ†æã€è°ƒç”¨é“¾è¿½è¸ªä¸‰é¡¹åŠŸèƒ½é€šè¿‡æµ‹è¯•
- [ ] åˆ†è¯­è¨€è§„åˆ™é›† (Python/JS/TS/Go/Java) å„è‡ªè‡³å°‘ 1 ä¸ª Linter å¯è¿è¡Œ
- [ ] `languages.yml` é…ç½®å¯è¦†ç›–é»˜è®¤æ‰©å±•åæ˜ å°„
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%

---

## 3. Gate 3.2: æ€§èƒ½ä¼˜åŒ–

> **å…³è”éœ€æ±‚**: FR-202
> **é¢„è®¡å·¥æœŸ**: 4 å¤©
> **å‰ç½®ä¾èµ–**: Gate 3.1 å®Œæˆ

### 3.1 ç›®æ ‡

é’ˆå¯¹å¤§å‹é¡¹ç›® (1000+ æ–‡ä»¶) åœºæ™¯ï¼Œé€šè¿‡å¢é‡æ£€æŸ¥ã€ç»“æœç¼“å­˜ã€å¹¶è¡Œæ‰§è¡Œå’ŒæŒ‰éœ€åŠ è½½å››é¡¹ä¼˜åŒ–ï¼Œå°† Linter æ£€æŸ¥å»¶è¿Ÿæ§åˆ¶åœ¨ 10 ç§’ä»¥å†…ã€‚

### 3.2 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Gate 3.2: æ€§èƒ½ä¼˜åŒ–æ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚  git diff    â”‚  åªè·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              å¢é‡æ£€æŸ¥å¼•æ“ (IncrementalChecker)             â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     å‘½ä¸­ç¼“å­˜     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ æ–‡ä»¶ Hash    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ è¿”å›ç¼“å­˜ç»“æœ     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ è®¡ç®— (SHA256)â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚   â”‚
â”‚  â”‚         â”‚ æœªå‘½ä¸­                                           â”‚   â”‚
â”‚  â”‚         â–¼                                                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚         å¹¶è¡Œæ‰§è¡Œå™¨ (concurrent.futures)           â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                                                    â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Worker 1 â”‚  â”‚ Worker 2 â”‚  â”‚ Worker N â”‚       â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ (è§„åˆ™A)  â”‚  â”‚ (è§„åˆ™B)  â”‚  â”‚ (è§„åˆ™C)  â”‚       â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚     â”‚   â”‚
â”‚  â”‚  â”‚       â”‚             â”‚             â”‚               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚       â–¼             â–¼             â–¼               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â”‚          ç»“æœèšåˆ + ç¼“å­˜å†™å…¥              â”‚    â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚  æŒ‰éœ€åŠ è½½    â”‚  åªåŠ è½½å½“å‰è¯­è¨€çš„è§„åˆ™é›†                        â”‚
â”‚  â”‚  (LazyLoader)â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 æ ¸å¿ƒæ¥å£

```python
import hashlib
from pathlib import Path
from concurrent.futures import ThreadPoolExecutor, as_completed
from dataclasses import dataclass
from typing import Optional

@dataclass
class CacheEntry:
    file_hash: str
    results: list       # list[LintResult]
    timestamp: float

class ResultCache:
    """åŸºäºæ–‡ä»¶ hash çš„ Lint ç»“æœç¼“å­˜"""

    def __init__(self, cache_dir: Path):
        self._cache_dir = cache_dir
        self._cache: dict[str, CacheEntry] = {}

    def get(self, file_path: Path) -> Optional[list]:
        """æŸ¥è¯¢ç¼“å­˜ï¼Œhash åŒ¹é…åˆ™è¿”å›ç»“æœï¼Œå¦åˆ™è¿”å› None"""
        file_hash = self._compute_hash(file_path)
        entry = self._cache.get(str(file_path))
        if entry and entry.file_hash == file_hash:
            return entry.results
        return None

    def put(self, file_path: Path, results: list) -> None:
        """å†™å…¥ç¼“å­˜"""
        ...

    def _compute_hash(self, file_path: Path) -> str:
        """è®¡ç®—æ–‡ä»¶ SHA256"""
        return hashlib.sha256(file_path.read_bytes()).hexdigest()


class IncrementalChecker:
    """å¢é‡ Linter æ£€æŸ¥å™¨ â€” åªæ£€æŸ¥ git diff å˜æ›´çš„æ–‡ä»¶"""

    def __init__(self, repo_root: Path, cache: ResultCache):
        self._repo_root = repo_root
        self._cache = cache

    def get_changed_files(self, base_ref: str = "HEAD") -> list[Path]:
        """é€šè¿‡ git diff è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨"""
        ...

    def check(self, files: list[Path]) -> list:
        """å¯¹å˜æ›´æ–‡ä»¶æ‰§è¡Œå¢é‡æ£€æŸ¥"""
        results = []
        uncached = []
        for f in files:
            cached = self._cache.get(f)
            if cached is not None:
                results.extend(cached)
            else:
                uncached.append(f)
        if uncached:
            new_results = self._run_parallel(uncached)
            results.extend(new_results)
        return results

    def _run_parallel(self, files: list[Path]) -> list:
        """å¹¶è¡Œæ‰§è¡Œ Lint æ£€æŸ¥"""
        ...


class ParallelExecutor:
    """ä¸‰å±‚è§„åˆ™å¹¶è¡Œæ‰§è¡Œå™¨"""

    def __init__(self, max_workers: int = 4):
        self._max_workers = max_workers

    def execute(self, tasks: list[callable]) -> list:
        """å¹¶è¡Œæ‰§è¡Œå¤šä¸ª Lint ä»»åŠ¡"""
        results = []
        with ThreadPoolExecutor(max_workers=self._max_workers) as pool:
            futures = {pool.submit(task): task for task in tasks}
            for future in as_completed(futures):
                results.extend(future.result())
        return results


class LazyRuleSetLoader:
    """æŒ‰éœ€åŠ è½½è§„åˆ™é›† â€” åªåŠ è½½å½“å‰è¯­è¨€éœ€è¦çš„è§„åˆ™"""

    _loaded: dict[str, object] = {}

    @classmethod
    def load(cls, language: str) -> object:
        if language not in cls._loaded:
            cls._loaded[language] = cls._import_ruleset(language)
        return cls._loaded[language]

    @classmethod
    def _import_ruleset(cls, language: str) -> object:
        """åŠ¨æ€å¯¼å…¥å¯¹åº”è¯­è¨€çš„è§„åˆ™é›†æ¨¡å—"""
        ...
```

### 3.4 å®æ–½æ­¥éª¤

| æ­¥éª¤ | ä»»åŠ¡ | äº§å‡º | é¢„è®¡è€—æ—¶ |
|:---:|------|------|:-------:|
| 1 | å®ç° `ResultCache` (SHA256 + æ–‡ä»¶ç¼“å­˜) | `cache.py` | 0.5 å¤© |
| 2 | å®ç° `IncrementalChecker` (git diff é›†æˆ) | `incremental.py` | 1 å¤© |
| 3 | å®ç° `ParallelExecutor` (concurrent.futures) | `parallel.py` | 0.5 å¤© |
| 4 | å®ç° `LazyRuleSetLoader` (æŒ‰éœ€åŠ è½½) | `lazy_loader.py` | 0.5 å¤© |
| 5 | æ€§èƒ½åŸºå‡†æµ‹è¯• (1000 æ–‡ä»¶é¡¹ç›®) | `benchmarks/` | 1 å¤© |
| 6 | å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• | `tests/test_gate_3_2_*.py` | 0.5 å¤© |

### 3.5 Gate å®Œæˆæ¡ä»¶

- [ ] `IncrementalChecker` æ­£ç¡®è¯†åˆ« git diff å˜æ›´æ–‡ä»¶
- [ ] `ResultCache` å‘½ä¸­ç‡åœ¨é‡å¤æ£€æŸ¥æ—¶ â‰¥ 90%
- [ ] `ParallelExecutor` åœ¨ 4 æ ¸æœºå™¨ä¸ŠåŠ é€Ÿæ¯” â‰¥ 2.5x
- [ ] `LazyRuleSetLoader` åªåŠ è½½å½“å‰è¯­è¨€çš„è§„åˆ™é›† (å†…å­˜å ç”¨é™ä½)
- [ ] 1000 æ–‡ä»¶é¡¹ç›®å¢é‡æ£€æŸ¥å»¶è¿Ÿ < 10 ç§’
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%

---

## 4. Gate 3.3: é…ç½®å¢å¼º

> **å…³è”éœ€æ±‚**: FR-201, FR-203, FR-204
> **é¢„è®¡å·¥æœŸ**: 5 å¤©
> **å‰ç½®ä¾èµ–**: Gate 3.1 å®Œæˆ

### 4.1 ç›®æ ‡

å®Œå–„é…ç½®ç³»ç»Ÿï¼Œæ”¯æŒ YAML å£°æ˜å¼ç¬¬ä¸‰å±‚è§„åˆ™ã€ä¸‰çº§ Linter è¯¯æŠ¥è±å…æœºåˆ¶ã€è·¨æ–‡ä»¶ä¾èµ–æ£€æŸ¥å’Œé…ç½®éªŒè¯å·¥å…·ï¼Œå®ç°é›¶ä»£ç è‡ªå®šä¹‰è§„åˆ™å’Œç²¾ç»†åŒ–è¯¯æŠ¥ç®¡ç†ã€‚

### 4.2 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Gate 3.3: é…ç½®å¢å¼ºæ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              YAML é…ç½®å±‚ (.claude/rules/)                  â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚ â”‚
â”‚  â”‚  â”‚  layer3.yml      â”‚  â”‚  ignore.yml      â”‚               â”‚ â”‚
â”‚  â”‚  â”‚  (ç¬¬ä¸‰å±‚è§„åˆ™)    â”‚  â”‚  (è§„åˆ™çº§è±å…)    â”‚               â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ â”‚
â”‚  â”‚           â”‚                      â”‚                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â”‚                      â”‚                            â”‚
â”‚              â–¼                      â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ é…ç½®éªŒè¯å·¥å…·     â”‚   â”‚ ä¸‰çº§è±å…å¼•æ“ (ExemptionEngine)   â”‚   â”‚
â”‚  â”‚ (ConfigValidator)â”‚   â”‚                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  Level 1: # noqa: RF001 (è¡Œçº§)   â”‚   â”‚
â”‚                          â”‚  Level 2: # nomos-ignore     â”‚   â”‚
â”‚                          â”‚           (æ–‡ä»¶çº§)                â”‚   â”‚
â”‚                          â”‚  Level 3: ignore.yml (è§„åˆ™çº§)     â”‚   â”‚
â”‚                          â”‚           + ä¸´æ—¶è±å… + è¿‡æœŸæ—¶é—´   â”‚   â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                          â”‚                       â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚              â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              ç¬¬ä¸‰å±‚è§„åˆ™å¼•æ“ (Layer3Engine)                 â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚ å£°æ˜å¼è§„åˆ™                                        â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  match.pattern  (æ­£åˆ™åŒ¹é…)                        â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  match.ast_type (AST èŠ‚ç‚¹ç±»å‹åŒ¹é…)                â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  require        (å¼ºåˆ¶è¦æ±‚)                        â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚ å¤æ‚è§„åˆ™å§”æ‰˜                                      â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  handler: path/to/custom_rule.py                  â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         è·¨æ–‡ä»¶ä¾èµ–æ£€æŸ¥ (CrossFileAnalyzer)                â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     AST è°ƒç”¨é“¾     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ æ–‡ä»¶ A   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ ä¾èµ–å›¾ (DAG)    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ æ–‡ä»¶ B   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ å¾ªç¯ä¾èµ–æ£€æµ‹    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ æ–‡ä»¶ C   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ æœªä½¿ç”¨å¯¼å…¥æ£€æµ‹  â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 æ ¸å¿ƒæ¥å£

```python
from pathlib import Path
from dataclasses import dataclass, field
from typing import Optional, Any
from datetime import datetime
import re
import importlib.util

# === YAML ç¬¬ä¸‰å±‚è§„åˆ™ ===
@dataclass
class DeclarativeRule:
    """å£°æ˜å¼è§„åˆ™ â€” ä» layer3.yml åŠ è½½"""
    rule_id: str
    description: str
    match_pattern: Optional[str] = None      # æ­£åˆ™åŒ¹é…
    match_ast_type: Optional[str] = None     # AST èŠ‚ç‚¹ç±»å‹
    require: Optional[str] = None            # å¼ºåˆ¶è¦æ±‚
    severity: str = "warning"

@dataclass
class DelegatedRule:
    """å¤æ‚è§„åˆ™å§”æ‰˜ â€” handler å¼•ç”¨ Python æ–‡ä»¶"""
    rule_id: str
    description: str
    handler: str                              # Python æ–‡ä»¶è·¯å¾„
    severity: str = "warning"

class Layer3Engine:
    """ç¬¬ä¸‰å±‚è§„åˆ™å¼•æ“"""

    def __init__(self, config_path: Path):
        self._rules: list[DeclarativeRule] = []
        self._delegated: list[DelegatedRule] = []
        self._load_config(config_path)

    def evaluate(self, file_path: Path, source: str, ast: Any) -> list:
        """è¯„ä¼°æ‰€æœ‰ç¬¬ä¸‰å±‚è§„åˆ™"""
        results = []
        results.extend(self._eval_declarative(file_path, source, ast))
        results.extend(self._eval_delegated(file_path, source, ast))
        return results

    def _eval_declarative(self, file_path: Path, source: str, ast: Any) -> list:
        """è¯„ä¼°å£°æ˜å¼è§„åˆ™"""
        results = []
        for rule in self._rules:
            if rule.match_pattern:
                for i, line in enumerate(source.splitlines(), 1):
                    if re.search(rule.match_pattern, line):
                        results.append({"rule": rule.rule_id, "line": i})
        return results

    def _eval_delegated(self, file_path: Path, source: str, ast: Any) -> list:
        """è¯„ä¼°å§”æ‰˜è§„åˆ™ â€” åŠ¨æ€åŠ è½½ handler"""
        results = []
        for rule in self._delegated:
            spec = importlib.util.spec_from_file_location("handler", rule.handler)
            mod = importlib.util.module_from_spec(spec)
            spec.loader.exec_module(mod)
            results.extend(mod.check(file_path, source, ast))
        return results

    def _load_config(self, config_path: Path) -> None:
        """ä» layer3.yml åŠ è½½è§„åˆ™é…ç½®"""
        ...


# === ä¸‰çº§è±å…æœºåˆ¶ ===
@dataclass
class Exemption:
    rule_id: str
    level: str              # "line" | "file" | "rule"
    reason: Optional[str] = None
    expires: Optional[datetime] = None

class ExemptionEngine:
    """ä¸‰çº§ Linter è¯¯æŠ¥è±å…å¼•æ“"""

    def __init__(self, ignore_yml_path: Optional[Path] = None):
        self._rule_exemptions: list[Exemption] = []
        if ignore_yml_path and ignore_yml_path.exists():
            self._load_rule_exemptions(ignore_yml_path)

    def is_exempted(self, rule_id: str, file_path: Path, line: int,
                    source_line: str) -> bool:
        """æ£€æŸ¥æŸæ¡ Lint ç»“æœæ˜¯å¦è¢«è±å…"""
        # Level 1: è¡Œçº§è±å… â€” # noqa: RF001
        if self._check_line_exemption(rule_id, source_line):
            return True
        # Level 2: æ–‡ä»¶çº§è±å… â€” # nomos-ignore: RF001, RF002
        if self._check_file_exemption(rule_id, file_path):
            return True
        # Level 3: è§„åˆ™çº§è±å… â€” ignore.yml (å«è¿‡æœŸæ—¶é—´)
        if self._check_rule_exemption(rule_id):
            return True
        return False

    def _check_line_exemption(self, rule_id: str, source_line: str) -> bool:
        """æ£€æŸ¥è¡Œçº§è±å…: # noqa: RF001"""
        match = re.search(r"#\s*noqa:\s*([\w,\s]+)", source_line)
        if match:
            exempted_rules = [r.strip() for r in match.group(1).split(",")]
            return rule_id in exempted_rules
        return False

    def _check_file_exemption(self, rule_id: str, file_path: Path) -> bool:
        """æ£€æŸ¥æ–‡ä»¶çº§è±å…: # nomos-ignore: RF001, RF002"""
        try:
            first_lines = file_path.read_text().splitlines()[:5]
            for line in first_lines:
                match = re.search(r"#\s*nomos-ignore:\s*([\w,\s]+)", line)
                if match:
                    exempted = [r.strip() for r in match.group(1).split(",")]
                    if rule_id in exempted:
                        return True
        except (OSError, UnicodeDecodeError):
            pass
        return False

    def _check_rule_exemption(self, rule_id: str) -> bool:
        """æ£€æŸ¥è§„åˆ™çº§è±å… (ignore.ymlï¼Œå«è¿‡æœŸæ—¶é—´)"""
        now = datetime.now()
        for ex in self._rule_exemptions:
            if ex.rule_id == rule_id:
                if ex.expires and ex.expires < now:
                    continue  # å·²è¿‡æœŸï¼Œä¸è±å…
                return True
        return False

    def _load_rule_exemptions(self, path: Path) -> None:
        """ä» ignore.yml åŠ è½½è§„åˆ™çº§è±å…"""
        ...


# === è·¨æ–‡ä»¶ä¾èµ–æ£€æŸ¥ ===
@dataclass
class Dependency:
    source_file: str
    target_file: str
    import_name: str

class CrossFileAnalyzer:
    """è·¨æ–‡ä»¶ä¾èµ–åˆ†æå™¨ â€” åŸºäº AST è°ƒç”¨é“¾"""

    def __init__(self, project_root: Path):
        self._root = project_root
        self._dep_graph: dict[str, list[Dependency]] = {}

    def build_dependency_graph(self, files: list[Path]) -> None:
        """æ„å»ºé¡¹ç›®ä¾èµ–å›¾ (DAG)"""
        ...

    def detect_circular_deps(self) -> list[list[str]]:
        """æ£€æµ‹å¾ªç¯ä¾èµ–"""
        ...

    def detect_unused_imports(self, file_path: Path) -> list[str]:
        """æ£€æµ‹æœªä½¿ç”¨çš„å¯¼å…¥"""
        ...


# === é…ç½®éªŒè¯å·¥å…· ===
class ConfigValidator:
    """éªŒè¯ YAML é…ç½®æ–‡ä»¶åˆæ³•æ€§"""

    SCHEMAS = {
        "layer3.yml": {...},
        "ignore.yml": {...},
        "languages.yml": {...},
    }

    def validate(self, config_path: Path) -> list[str]:
        """éªŒè¯é…ç½®æ–‡ä»¶ï¼Œè¿”å›é”™è¯¯åˆ—è¡¨ (ç©ºåˆ—è¡¨ = åˆæ³•)"""
        ...
```

### 4.4 é…ç½®æ–‡ä»¶ç¤ºä¾‹

```yaml
# .claude/rules/layer3.yml
version: "1.0"

rules:
  # å£°æ˜å¼è§„åˆ™ â€” æ­£åˆ™åŒ¹é…
  - id: RF-L3-001
    description: "ç¦æ­¢ä½¿ç”¨ eval()"
    severity: error
    match:
      pattern: "\\beval\\s*\\("
    require: null

  # å£°æ˜å¼è§„åˆ™ â€” AST èŠ‚ç‚¹åŒ¹é…
  - id: RF-L3-002
    description: "æ‰€æœ‰å…¬å¼€å‡½æ•°å¿…é¡»æœ‰ docstring"
    severity: warning
    match:
      ast_type: "function_definition"
    require: "docstring"

  # å¤æ‚è§„åˆ™å§”æ‰˜
  - id: RF-L3-003
    description: "è‡ªå®šä¹‰å®‰å…¨æ£€æŸ¥"
    severity: error
    handler: ".claude/rules/handlers/security_check.py"
```

```yaml
# .claude/rules/ignore.yml
version: "1.0"

exemptions:
  # æ°¸ä¹…è±å…
  - rule_id: RF-L3-001
    reason: "é—ç•™ä»£ç ï¼Œè®¡åˆ’åœ¨ v2.0 é‡æ„"
    files:
      - "src/legacy/*.py"

  # ä¸´æ—¶è±å… (å«è¿‡æœŸæ—¶é—´)
  - rule_id: RF-L3-002
    reason: "Sprint 3 ç»“æŸå‰è¡¥é½ docstring"
    expires: "2026-04-01"
    files:
      - "src/new_module/*.py"
```

### 4.5 å®æ–½æ­¥éª¤

| æ­¥éª¤ | ä»»åŠ¡ | äº§å‡º | é¢„è®¡è€—æ—¶ |
|:---:|------|------|:-------:|
| 1 | å®ç° `Layer3Engine` (å£°æ˜å¼ + å§”æ‰˜) | `layer3_engine.py` | 1.5 å¤© |
| 2 | å®ç° `ExemptionEngine` (ä¸‰çº§è±å…) | `exemption.py` | 1 å¤© |
| 3 | å®ç° `CrossFileAnalyzer` (ä¾èµ–å›¾ + å¾ªç¯æ£€æµ‹) | `cross_file.py` | 1 å¤© |
| 4 | å®ç° `ConfigValidator` (YAML Schema éªŒè¯) | `config_validator.py` | 0.5 å¤© |
| 5 | ç¼–å†™é…ç½®æ–‡ä»¶æ¨¡æ¿ (layer3.yml, ignore.yml) | `.claude/rules/` | 0.5 å¤© |
| 6 | å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• | `tests/test_gate_3_3_*.py` | 0.5 å¤© |

### 4.6 Gate å®Œæˆæ¡ä»¶

- [ ] `Layer3Engine` æ­£ç¡®è§£æå£°æ˜å¼è§„åˆ™ (æ­£åˆ™ + AST) å’Œå§”æ‰˜è§„åˆ™
- [ ] `ExemptionEngine` ä¸‰çº§è±å…å‡å¯æ­£å¸¸å·¥ä½œ (è¡Œçº§/æ–‡ä»¶çº§/è§„åˆ™çº§)
- [ ] ä¸´æ—¶è±å…è¿‡æœŸåè‡ªåŠ¨å¤±æ•ˆ
- [ ] `CrossFileAnalyzer` å¯æ£€æµ‹å¾ªç¯ä¾èµ–å’Œæœªä½¿ç”¨å¯¼å…¥
- [ ] `ConfigValidator` å¯éªŒè¯ä¸‰ç§ YAML é…ç½®æ–‡ä»¶çš„åˆæ³•æ€§
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%

---

## 5. Gate 3.4: æ–‡æ¡£ä¸æµ‹è¯•

> **é¢„è®¡å·¥æœŸ**: 4 å¤©
> **å‰ç½®ä¾èµ–**: Gate 3.1, 3.2, 3.3 å…¨éƒ¨å®Œæˆ

### 5.1 ç›®æ ‡

å»ºç«‹å®Œæ•´çš„ç”¨æˆ·æ–‡æ¡£ä½“ç³»å’Œæµ‹è¯•ä½“ç³»ï¼Œç¡®ä¿ Phase 3 æ‰€æœ‰åŠŸèƒ½æœ‰æ®å¯æŸ¥ã€æœ‰æµ‹å¯éªŒã€‚

### 5.2 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Gate 3.4: æ–‡æ¡£ä¸æµ‹è¯•æ¶æ„                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    æ–‡æ¡£ä½“ç³»                                 â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚  å®‰è£…æŒ‡å—    â”‚  â”‚  å¿«é€Ÿå¼€å§‹    â”‚  â”‚  é…ç½®å‚è€ƒ    â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  (Install)   â”‚  â”‚  (QuickStart)â”‚  â”‚  (Config Ref)â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚ â”‚
â”‚  â”‚  â”‚  æ•…éšœæ’æŸ¥    â”‚  â”‚  API æ–‡æ¡£    â”‚                       â”‚ â”‚
â”‚  â”‚  â”‚  (Trouble-   â”‚  â”‚  (05_API_    â”‚                       â”‚ â”‚
â”‚  â”‚  â”‚   shooting)  â”‚  â”‚  Documenta-  â”‚                       â”‚ â”‚
â”‚  â”‚  â”‚              â”‚  â”‚  tion.md æ›´æ–°)â”‚                       â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    æµ‹è¯•ä½“ç³»                                 â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚  â”‚              pytest æµ‹è¯•æ¡†æ¶                       â”‚     â”‚ â”‚
â”‚  â”‚  â”‚                                                    â”‚     â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚     â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  å•å…ƒæµ‹è¯•    â”‚     â”‚  é›†æˆæµ‹è¯•    â”‚           â”‚     â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  (unit/)     â”‚     â”‚  (integration/)â”‚          â”‚     â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  è¦†ç›–ç‡â‰¥80% â”‚     â”‚  ç«¯åˆ°ç«¯æµç¨‹  â”‚           â”‚     â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚     â”‚ â”‚
â”‚  â”‚  â”‚                                                    â”‚     â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  è¦†ç›–ç‡æŠ¥å‘Š (pytest-cov + HTML report)   â”‚    â”‚     â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 æ–‡æ¡£æ¸…å•

| æ–‡æ¡£ | ç±»å‹ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|:---:|
| å®‰è£…æŒ‡å— | ç”¨æˆ·æ–‡æ¡£ | ç¯å¢ƒè¦æ±‚ã€ä¾èµ–å®‰è£…ã€åˆå§‹åŒ–é…ç½® | ğŸ†• æ–°å»º |
| å¿«é€Ÿå¼€å§‹ | ç”¨æˆ·æ–‡æ¡£ | 5 åˆ†é’Ÿä¸Šæ‰‹æ•™ç¨‹ã€æœ€å°é…ç½®ç¤ºä¾‹ | ğŸ†• æ–°å»º |
| é…ç½®å‚è€ƒ | ç”¨æˆ·æ–‡æ¡£ | æ‰€æœ‰ YAML é…ç½®é¡¹è¯¦ç»†è¯´æ˜ | ğŸ†• æ–°å»º |
| æ•…éšœæ’æŸ¥ | ç”¨æˆ·æ–‡æ¡£ | å¸¸è§é—®é¢˜ FAQã€é”™è¯¯ç è¯´æ˜ | ğŸ†• æ–°å»º |
| API æ–‡æ¡£ | å¼€å‘æ–‡æ¡£ | å·²æœ‰ 05_API_Documentation.mdï¼Œéœ€æ›´æ–° Phase 3 æ¥å£ | âœï¸ æ›´æ–° |

### 5.4 æµ‹è¯•ç­–ç•¥

```python
# === æµ‹è¯•ç›®å½•ç»“æ„ ===
# tests/
# â”œâ”€â”€ unit/
# â”‚   â”œâ”€â”€ test_language_detector.py      (Gate 3.1)
# â”‚   â”œâ”€â”€ test_tree_sitter_engine.py     (Gate 3.1)
# â”‚   â”œâ”€â”€ test_rulesets.py               (Gate 3.1)
# â”‚   â”œâ”€â”€ test_cache.py                  (Gate 3.2)
# â”‚   â”œâ”€â”€ test_incremental.py            (Gate 3.2)
# â”‚   â”œâ”€â”€ test_parallel.py               (Gate 3.2)
# â”‚   â”œâ”€â”€ test_layer3_engine.py          (Gate 3.3)
# â”‚   â”œâ”€â”€ test_exemption.py              (Gate 3.3)
# â”‚   â”œâ”€â”€ test_cross_file.py             (Gate 3.3)
# â”‚   â””â”€â”€ test_config_validator.py       (Gate 3.3)
# â”œâ”€â”€ integration/
# â”‚   â”œâ”€â”€ test_e2e_multilang.py          (Gate 3.1 ç«¯åˆ°ç«¯)
# â”‚   â”œâ”€â”€ test_e2e_performance.py        (Gate 3.2 ç«¯åˆ°ç«¯)
# â”‚   â””â”€â”€ test_e2e_config.py             (Gate 3.3 ç«¯åˆ°ç«¯)
# â”œâ”€â”€ fixtures/
# â”‚   â”œâ”€â”€ sample_python.py
# â”‚   â”œâ”€â”€ sample_javascript.js
# â”‚   â”œâ”€â”€ sample_typescript.ts
# â”‚   â”œâ”€â”€ sample_go.go
# â”‚   â””â”€â”€ sample_java.java
# â””â”€â”€ conftest.py

import pytest

# === å•å…ƒæµ‹è¯•ç¤ºä¾‹ ===
class TestLanguageDetector:
    """Gate 3.1 â€” è¯­è¨€æ£€æµ‹å™¨æµ‹è¯•"""

    def test_detect_python(self, detector):
        assert detector.detect(Path("main.py")) == Language.PYTHON

    def test_detect_unknown(self, detector):
        assert detector.detect(Path("data.csv")) == Language.UNKNOWN

    def test_custom_config_override(self, detector_with_config):
        """è‡ªå®šä¹‰é…ç½®è¦†ç›–é»˜è®¤æ˜ å°„"""
        ...

class TestExemptionEngine:
    """Gate 3.3 â€” è±å…å¼•æ“æµ‹è¯•"""

    def test_line_exemption(self, engine):
        line = 'result = eval(expr)  # noqa: RF-L3-001'
        assert engine.is_exempted("RF-L3-001", Path("f.py"), 1, line)

    def test_expired_exemption(self, engine_with_expired):
        """è¿‡æœŸè±å…ä¸ç”Ÿæ•ˆ"""
        ...
```

### 5.5 å®æ–½æ­¥éª¤

| æ­¥éª¤ | ä»»åŠ¡ | äº§å‡º | é¢„è®¡è€—æ—¶ |
|:---:|------|------|:-------:|
| 1 | ç¼–å†™å®‰è£…æŒ‡å— + å¿«é€Ÿå¼€å§‹ | `docs/install.md`, `docs/quickstart.md` | 0.5 å¤© |
| 2 | ç¼–å†™é…ç½®å‚è€ƒ + æ•…éšœæ’æŸ¥ | `docs/config_ref.md`, `docs/troubleshooting.md` | 0.5 å¤© |
| 3 | æ›´æ–° API æ–‡æ¡£ (Phase 3 æ¥å£) | `05_API_Documentation.md` æ›´æ–° | 0.5 å¤© |
| 4 | ç¼–å†™å•å…ƒæµ‹è¯• (Gate 3.1/3.2/3.3) | `tests/unit/` | 1 å¤© |
| 5 | ç¼–å†™é›†æˆæµ‹è¯• (ç«¯åˆ°ç«¯æµç¨‹) | `tests/integration/` | 1 å¤© |
| 6 | é…ç½® pytest-cov + ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š | `pytest.ini`, `htmlcov/` | 0.5 å¤© |

### 5.6 Gate å®Œæˆæ¡ä»¶

- [ ] å®‰è£…æŒ‡å—ã€å¿«é€Ÿå¼€å§‹ã€é…ç½®å‚è€ƒã€æ•…éšœæ’æŸ¥å››ç¯‡ç”¨æˆ·æ–‡æ¡£å®Œæˆ
- [ ] API æ–‡æ¡£æ›´æ–°è¦†ç›– Phase 3 æ‰€æœ‰å…¬å¼€æ¥å£
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- [ ] é›†æˆæµ‹è¯•è¦†ç›– Gate 3.1/3.2/3.3 æ ¸å¿ƒæµç¨‹
- [ ] pytest-cov æŠ¥å‘Šå¯æ­£å¸¸ç”Ÿæˆ

---

## 6. Gate é—´ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Phase 3 Gate ä¾èµ–å…³ç³»å›¾                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                  â”‚  Phase 2 å®Œæˆ    â”‚                            â”‚
â”‚                  â”‚  (å‰ç½®ä¾èµ–)      â”‚                            â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                           â”‚                                      â”‚
â”‚                           â–¼                                      â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                  â”‚  Gate 3.1        â”‚                            â”‚
â”‚                  â”‚  å¤šè¯­è¨€æ”¯æŒ      â”‚                            â”‚
â”‚                  â”‚  (5 å¤©)          â”‚                            â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                           â”‚                                      â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                â”‚                     â”‚                           â”‚
â”‚                â–¼                     â–¼                           â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚       â”‚  Gate 3.2        â”‚  â”‚  Gate 3.3        â”‚               â”‚
â”‚       â”‚  æ€§èƒ½ä¼˜åŒ–        â”‚  â”‚  é…ç½®å¢å¼º        â”‚               â”‚
â”‚       â”‚  (4 å¤©)          â”‚  â”‚  (5 å¤©)          â”‚               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                â”‚                     â”‚                           â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                           â”‚                                      â”‚
â”‚                           â–¼                                      â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                  â”‚  Gate 3.4        â”‚                            â”‚
â”‚                  â”‚  æ–‡æ¡£ä¸æµ‹è¯•      â”‚                            â”‚
â”‚                  â”‚  (4 å¤©)          â”‚                            â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                  â”‚
â”‚  å…³é”®è·¯å¾„: Phase 2 â–º 3.1 â–º 3.3 â–º 3.4 (å…± 14 å¤©)               â”‚
â”‚  å¹¶è¡Œè·¯å¾„: 3.2 ä¸ 3.3 å¯å¹¶è¡Œ (èŠ‚çœ 4 å¤©)                        â”‚
â”‚  æœ€çŸ­å·¥æœŸ: çº¦ 14 å¤© (å«å¹¶è¡Œ)                                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| Gate | å‰ç½®ä¾èµ– | åç½®ä¾èµ– | å¯å¹¶è¡Œ |
|------|---------|---------|:------:|
| Gate 3.1 å¤šè¯­è¨€æ”¯æŒ | Phase 2 å®Œæˆ | Gate 3.2, 3.3 | - |
| Gate 3.2 æ€§èƒ½ä¼˜åŒ– | Gate 3.1 | Gate 3.4 | ä¸ 3.3 å¹¶è¡Œ |
| Gate 3.3 é…ç½®å¢å¼º | Gate 3.1 | Gate 3.4 | ä¸ 3.2 å¹¶è¡Œ |
| Gate 3.4 æ–‡æ¡£ä¸æµ‹è¯• | Gate 3.1, 3.2, 3.3 | - | - |

---

## 7. éªŒæ”¶æ ‡å‡†

### 7.1 åŠŸèƒ½éªŒæ”¶

| ç¼–å· | éªŒæ”¶é¡¹ | éªŒæ”¶æ¡ä»¶ | å…³è” Gate |
|:---:|--------|---------|:---------:|
| AC-01 | å¤šè¯­è¨€ AST è§£æ | 5 ç§è¯­è¨€å‡å¯è§£æå¹¶æå–å‡½æ•°ç­¾å | 3.1 |
| AC-02 | è¯­è¨€è‡ªåŠ¨æ£€æµ‹ | æ‰©å±•åæ˜ å°„å‡†ç¡®ç‡ 100% | 3.1 |
| AC-03 | åˆ†è¯­è¨€è§„åˆ™é›† | æ¯ç§è¯­è¨€è‡³å°‘ 1 ä¸ª Linter å¯è¿è¡Œ | 3.1 |
| AC-04 | å¢é‡æ£€æŸ¥ | åªæ£€æŸ¥ git diff å˜æ›´æ–‡ä»¶ | 3.2 |
| AC-05 | ç»“æœç¼“å­˜ | é‡å¤æ£€æŸ¥å‘½ä¸­ç‡ â‰¥ 90% | 3.2 |
| AC-06 | å¹¶è¡Œæ‰§è¡Œ | 4 æ ¸åŠ é€Ÿæ¯” â‰¥ 2.5x | 3.2 |
| AC-07 | YAML ç¬¬ä¸‰å±‚è§„åˆ™ | å£°æ˜å¼ + å§”æ‰˜è§„åˆ™å‡å¯æ‰§è¡Œ | 3.3 |
| AC-08 | ä¸‰çº§è±å… | è¡Œçº§/æ–‡ä»¶çº§/è§„åˆ™çº§è±å…å‡ç”Ÿæ•ˆ | 3.3 |
| AC-09 | ä¸´æ—¶è±å…è¿‡æœŸ | è¿‡æœŸåè‡ªåŠ¨å¤±æ•ˆ | 3.3 |
| AC-10 | è·¨æ–‡ä»¶ä¾èµ– | å¾ªç¯ä¾èµ–å’Œæœªä½¿ç”¨å¯¼å…¥å¯æ£€æµ‹ | 3.3 |
| AC-11 | é…ç½®éªŒè¯ | éæ³• YAML é…ç½®å¯æŠ¥é”™ | 3.3 |
| AC-12 | ç”¨æˆ·æ–‡æ¡£ | å››ç¯‡æ–‡æ¡£å®Œæ•´å¯ç”¨ | 3.4 |
| AC-13 | æµ‹è¯•è¦†ç›–ç‡ | å•å…ƒæµ‹è¯• â‰¥ 80% | 3.4 |

### 7.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|------|--------|---------|
| å¢é‡æ£€æŸ¥å»¶è¿Ÿ (1000 æ–‡ä»¶) | < 10 ç§’ | åŸºå‡†æµ‹è¯•è„šæœ¬ |
| ç¼“å­˜å‘½ä¸­ç‡ (é‡å¤æ£€æŸ¥) | â‰¥ 90% | è¿ç»­ä¸¤æ¬¡æ£€æŸ¥å¯¹æ¯” |
| å¹¶è¡ŒåŠ é€Ÿæ¯” (4 æ ¸) | â‰¥ 2.5x | ä¸²è¡Œ vs å¹¶è¡Œè€—æ—¶å¯¹æ¯” |
| å†…å­˜å ç”¨ (æŒ‰éœ€åŠ è½½) | é™ä½ â‰¥ 30% | åŠ è½½å…¨éƒ¨ vs æŒ‰éœ€åŠ è½½å¯¹æ¯” |

---

## 8. æŠ€æœ¯å†³ç­–è®°å½•

### TDR-301: Tree-sitter é€‰å‹

| é¡¹ç›® | å†…å®¹ |
|------|------|
| å†³ç­– | ä½¿ç”¨ Tree-sitter ä½œä¸ºå¤šè¯­è¨€ AST è§£æå¼•æ“ |
| åŸå›  | æ”¯æŒ 100+ è¯­è¨€ã€å¢é‡è§£æã€C çº§æ€§èƒ½ã€Python ç»‘å®šæˆç†Ÿ |
| æ›¿ä»£æ–¹æ¡ˆ | ast (ä»… Python)ã€babel (ä»… JS)ã€å„è¯­è¨€ç‹¬ç«‹è§£æå™¨ |
| é£é™© | Tree-sitter è¯­æ³•æ–‡ä»¶éœ€è¦å•ç‹¬å®‰è£…ï¼Œå¢åŠ éƒ¨ç½²å¤æ‚åº¦ |
| ç¼“è§£ | ä½¿ç”¨ tree-sitter-languages åŒ…ï¼Œä¸€æ¬¡å®‰è£…æ‰€æœ‰è¯­è¨€ |

### TDR-302: ç¼“å­˜ç­–ç•¥

| é¡¹ç›® | å†…å®¹ |
|------|------|
| å†³ç­– | åŸºäºæ–‡ä»¶ SHA256 hash çš„æœ¬åœ°æ–‡ä»¶ç¼“å­˜ |
| åŸå›  | ç®€å•å¯é ï¼Œæ— éœ€å¤–éƒ¨ä¾èµ–ï¼Œhash ç¢°æ’æ¦‚ç‡æä½ |
| æ›¿ä»£æ–¹æ¡ˆ | Redis ç¼“å­˜ã€SQLite ç¼“å­˜ã€å†…å­˜ LRU ç¼“å­˜ |
| é£é™© | å¤§é‡æ–‡ä»¶æ—¶ç¼“å­˜ç›®å½•è†¨èƒ€ |
| ç¼“è§£ | å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜ (LRU æ·˜æ±°ç­–ç•¥) |

### TDR-303: è±å…æœºåˆ¶è®¾è®¡

| é¡¹ç›® | å†…å®¹ |
|------|------|
| å†³ç­– | ä¸‰çº§è±å… (è¡Œçº§ / æ–‡ä»¶çº§ / è§„åˆ™çº§) + ä¸´æ—¶è±å…è¿‡æœŸ |
| åŸå›  | å…¼é¡¾ç²¾ç»†åº¦å’Œä¾¿åˆ©æ€§ï¼Œä¸´æ—¶è±å…é˜²æ­¢æ°¸ä¹…ç»•è¿‡ |
| æ›¿ä»£æ–¹æ¡ˆ | ä»…è¡Œçº§è±å…ã€ä»…å…¨å±€è±å… |
| é£é™© | è¿‡å¤šè±å…å¯¼è‡´è§„åˆ™å½¢åŒè™šè®¾ |
| ç¼“è§£ | è±å…å®¡è®¡æŠ¥å‘Š (å®šæœŸç»Ÿè®¡è±å…æ•°é‡å’Œè¿‡æœŸæƒ…å†µ) |

---

## é™„å½• A: éœ€æ±‚è¿½æº¯çŸ©é˜µ

| éœ€æ±‚ ID | éœ€æ±‚æè¿° | å…³è” Gate | å…³è”æ¥å£ | éªŒæ”¶ç¼–å· |
|:-------:|---------|:---------:|---------|:--------:|
| FR-101 | å¤šè¯­è¨€ AST è§£ææ”¯æŒ | 3.1 | `TreeSitterEngine`, `LanguageDetector` | AC-01, AC-02 |
| FR-202 | å¢é‡æ£€æŸ¥ä¸æ€§èƒ½ä¼˜åŒ– | 3.2 | `IncrementalChecker`, `ResultCache`, `ParallelExecutor` | AC-04, AC-05, AC-06 |
| FR-201 | YAML ç¬¬ä¸‰å±‚è§„åˆ™é…ç½® | 3.3 | `Layer3Engine` | AC-07 |
| FR-203 | Linter è¯¯æŠ¥è±å…æœºåˆ¶ | 3.3 | `ExemptionEngine` | AC-08, AC-09 |
| FR-204 | è·¨æ–‡ä»¶ä¾èµ–æ£€æŸ¥ | 3.3 | `CrossFileAnalyzer` | AC-10 |

## é™„å½• B: æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | å…³è” Gate |
|---------|------|:---------:|
| `src/language_detector.py` | è¯­è¨€è‡ªåŠ¨æ£€æµ‹å™¨ | 3.1 |
| `src/tree_sitter_engine.py` | Tree-sitter è§£æå¼•æ“ | 3.1 |
| `src/rulesets/*.py` | åˆ†è¯­è¨€è§„åˆ™é›† | 3.1 |
| `src/config/languages.py` | è¯­è¨€é…ç½®åŠ è½½ | 3.1 |
| `.claude/rules/languages.yml` | è¯­è¨€é…ç½®æ–‡ä»¶ | 3.1 |
| `src/cache.py` | ç»“æœç¼“å­˜ | 3.2 |
| `src/incremental.py` | å¢é‡æ£€æŸ¥å™¨ | 3.2 |
| `src/parallel.py` | å¹¶è¡Œæ‰§è¡Œå™¨ | 3.2 |
| `src/lazy_loader.py` | æŒ‰éœ€åŠ è½½å™¨ | 3.2 |
| `src/layer3_engine.py` | ç¬¬ä¸‰å±‚è§„åˆ™å¼•æ“ | 3.3 |
| `src/exemption.py` | è±å…å¼•æ“ | 3.3 |
| `src/cross_file.py` | è·¨æ–‡ä»¶åˆ†æå™¨ | 3.3 |
| `src/config_validator.py` | é…ç½®éªŒè¯å·¥å…· | 3.3 |
| `.claude/rules/layer3.yml` | ç¬¬ä¸‰å±‚è§„åˆ™é…ç½® | 3.3 |
| `.claude/rules/ignore.yml` | è±å…é…ç½® | 3.3 |
| `docs/install.md` | å®‰è£…æŒ‡å— | 3.4 |
| `docs/quickstart.md` | å¿«é€Ÿå¼€å§‹ | 3.4 |
| `docs/config_ref.md` | é…ç½®å‚è€ƒ | 3.4 |
| `docs/troubleshooting.md` | æ•…éšœæ’æŸ¥ | 3.4 |
| `05_API_Documentation.md` | API æ–‡æ¡£ (æ›´æ–°) | 3.4 |
| `tests/unit/` | å•å…ƒæµ‹è¯• | 3.4 |
| `tests/integration/` | é›†æˆæµ‹è¯• | 3.4 |

---

*æœ€åæ›´æ–°: 2026-02-25*
